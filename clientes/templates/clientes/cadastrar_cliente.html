{% extends 'core/base.html' %}
{% load static %}

{% block content_title %}Cadastrar Cliente{% endblock %}
{% block content %}
<div class="container-fluid" style="width: 100%; padding-right: 0;">
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-gradient" style="background: linear-gradient(45deg, #dc3545, #e4606d);">
            <h5 class="text-white m-0" style="font-size: 1.2rem; font-weight: 600;">Novo Cliente</h5>
        </div>
        <div class="card-body">
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-3" role="alert" style="color: #000;">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
            {% endif %}
            <form method="post" id="cliente-form" class="row g-3">
                {% csrf_token %}
                {{ formset.management_form }}
                <div class="col-12 col-md-6">
                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-person"></i> Nome</label>
                    {{ form.nome }}
                    <small class="form-text text-muted">Obrigatório</small>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-person-badge"></i> Apelido/Referência Pessoal</label>
                    {{ form.apelido }}
                    <small class="form-text text-muted">Ex.: Vítor, Joãozinho</small>
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-calendar"></i> Data de Nascimento</label>
                    {{ form.data_nascimento }}
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-hash"></i> Idade</label>
                    {{ form.idade }}
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-card-text"></i> CPF (000.000.000-00)</label>
                    {{ form.cpf }}
                    <small class="form-text text-muted" title="Formato: 000.000.000-00" aria-label="Formato: 000.000.000-00">Formato: 000.000.000-00</small>
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-envelope"></i> Email</label>
                    {{ form.email }}
                </div>
                <div class="col-12 col-md-3">
                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-telephone"></i> Número do Telefone</label>
                    {{ form.numero }}
                </div>
                <div class="col-12">
                    <h5 style="color: #000; font-size: 1.2rem; font-weight: 600;">Endereços</h5>
                    <div id="endereco-formset-container">
                        {% for endereco_form in formset %}
                        <div class="endereco-formset mb-3 p-3 border rounded">
                            {{ endereco_form.id }}
                            <div class="row g-3">
                                <div class="col-12 col-md-3">
                                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-pin-map"></i> CEP</label>
                                    {{ endereco_form.cep }}
                                </div>
                                <div class="col-12 col-md-6">
                                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-house"></i> Endereço</label>
                                    {{ endereco_form.endereco }}
                                </div>
                                <div class="col-12 col-md-3">
                                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-123"></i> Número</label>
                                    {{ endereco_form.numero_endereco }}
                                </div>
                                <div class="col-12 col-md-3">
                                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-plus"></i> Complemento</label>
                                    {{ endereco_form.complemento }}
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-geo-alt"></i> Bairro</label>
                                    {{ endereco_form.bairro }}
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-building"></i> Cidade</label>
                                    {{ endereco_form.cidade }}
                                </div>
                                <div class="col-12 col-md-4">
                                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-map"></i> Estado</label>
                                    {{ endereco_form.estado }}
                                </div>
                                <div class="col-12 col-md-3">
                                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-star"></i> Principal</label>
                                    {{ endereco_form.is_principal }}
                                </div>
                                <div class="col-12 col-md-3">
                                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-trash"></i> Excluir</label>
                                    {{ endereco_form.DELETE }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button type="button" class="btn btn-custom-add p-2 mt-2" id="add-endereco">
                        <i class="bi bi-plus-circle"></i> Adicionar Outro Endereço
                    </button>
                </div>
                <div class="col-12">
                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-exclamation-triangle"></i> Intolerâncias</label>
                    <div class="row row-cols-2 row-cols-md-3 g-2 mb-3" id="intolerancias-container">
                        {% for intolerancia in intolerancias_comuns %}
                        <div class="col">
                            <div class="form-check custom-checkbox">
                                <input type="checkbox" name="intolerancias" value="{{ intolerancia }}" class="form-check-input" id="intolerancia_{{ forloop.counter }}" {% if intolerancia in form.intolerancias.value %}checked{% endif %}>
                                <label class="form-check-label" for="intolerancia_{{ forloop.counter }}" style="color: #000; font-weight: 500;">{{ intolerancia }}</label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="outra-intolerancia" style="display:none;">
                        <label class="form-label mt-2" style="color: #000; font-size: 1rem; font-weight: 500;">Outra Intolerância</label>
                        {{ form.outra_intolerancia }}
                    </div>
                    <button type="button" class="btn btn-custom-add p-2 mt-2" id="add-outra-intolerancia">
                        <i class="bi bi-plus-circle"></i> Adicionar Outra Intolerância
                    </button>
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-apple"></i> Preferências Alimentares</label>
                    {{ form.preferencias_alimentares }}
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-pencil"></i> Observações</label>
                    {{ form.observacoes }}
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label" style="color: #000; font-size: 1rem; font-weight: 500;"><i class="bi bi-toggle-on"></i> Ativo</label>
                    {{ form.ativo }}
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary" style="color: #000;">Cadastrar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<style>
    .custom-checkbox .form-check-input {
        border: 2px solid #dc3545;
        border-radius: 4px;
    }
    .custom-checkbox .form-check-input:checked {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    .custom-checkbox .form-check-label {
        font-weight: 500;
        color: #000;
    }
    .btn-custom-add {
        color: #fff;
        background: linear-gradient(45deg, #dc3545, #e4606d);
        border: none;
        border-radius: 8px;
        padding: 8px 15px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
    }
    .btn-custom-add i {
        margin-right: 5px;
    }
    .btn-custom-add:hover {
        background: linear-gradient(45deg, #b02a37, #c44d58);
        transform: scale(1.05);
    }
    .cep-error {
        border: 2px solid #dc3545;
        background-color: #fff5f5;
        animation: shake 0.5s;
    }
    @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
        100% { transform: translateX(0); }
    }
    .endereco-formset {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .form-control:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }
    .form-text {
        font-size: 0.875rem;
    }
    @media (max-width: 768px) {
        .row.g-3 {
            flex-direction: column;
        }
        .col-12 {
            margin-bottom: 10px;
        }
    }
    @media (max-width: 576px) {
        .form-label {
            font-size: 0.9rem;
        }
        .btn-custom-add {
            width: 100%;
        }
    }
</style>
<script>
    let debounceTimeout;

    function formatAndFetchCep(input) {
        let cep = input.value.replace(/\D/g, '');
        console.log('CEP bruto:', input.value, 'Formatado sem hífen:', cep);

        if (cep.length > 5) {
            cep = cep.slice(0, 5) + '-' + cep.slice(5, 8);
        }
        input.value = cep.slice(0, 9);

        const cleanCep = input.value.replace('-', '');
        if (cleanCep.length === 8 && /^\d{8}$/.test(cleanCep)) {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                console.log('Chamando API para CEP:', cleanCep);
                fetch(`https://viacep.com.br/ws/${cleanCep}/json/`)
                    .then(response => {
                        if (!response.ok) {
                            console.log('Erro na resposta:', response.status, response.statusText);
                            throw new Error(`Erro na requisição: ${response.status} - ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Dados da API:', data);
                        const container = input.closest('.endereco-formset');
                        if (!container) {
                            console.error('Container .endereco-formset não encontrado!');
                            return;
                        }
                        const enderecoInput = container.querySelector('input[name$="endereco"]');
                        const bairroInput = container.querySelector('input[name$="bairro"]');
                        const cidadeInput = container.querySelector('input[name$="cidade"]');
                        const estadoInput = container.querySelector('input[name$="estado"]');
                        if (!data.erro) {
                            enderecoInput.value = data.logradouro || '';
                            bairroInput.value = data.bairro || '';
                            cidadeInput.value = data.localidade || '';
                            estadoInput.value = data.uf || '';
                            console.log('Campos preenchidos:', {
                                endereco: enderecoInput.value,
                                bairro: bairroInput.value,
                                cidade: cidadeInput.value,
                                estado: estadoInput.value
                            });
                            input.classList.remove('cep-error');
                        } else {
                            alert('CEP não encontrado!');
                            enderecoInput.value = '';
                            bairroInput.value = '';
                            cidadeInput.value = '';
                            estadoInput.value = '';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao buscar CEP:', error);
                        alert('Erro ao consultar o CEP. Verifique a conexão ou tente novamente. Detalhes: ' + error.message);
                    });
            }, 500);
        } else if (cleanCep.length !== 8) {
            const container = input.closest('.endereco-formset');
            const enderecoInput = container.querySelector('input[name$="endereco"]');
            const bairroInput = container.querySelector('input[name$="bairro"]');
            const cidadeInput = container.querySelector('input[name$="cidade"]');
            const estadoInput = container.querySelector('input[name$="estado"]');
            enderecoInput.value = '';
            bairroInput.value = '';
            cidadeInput.value = '';
            estadoInput.value = '';
            if (cleanCep.length > 0 && !/^\d+$/.test(cleanCep)) {
                input.classList.add('cep-error');
                console.log('CEP contém caracteres inválidos');
            } else {
                input.classList.remove('cep-error');
            }
        }
    }

    // Adicionar listener a todos os inputs de CEP no formset
    document.addEventListener('DOMContentLoaded', function() {
        const cepInputs = document.querySelectorAll('input[name$="cep"]');
        cepInputs.forEach(input => {
            input.addEventListener('input', function() {
                formatAndFetchCep(this);
            });
        });

        document.getElementById('add-outra-intolerancia').addEventListener('click', function() {
            const div = document.getElementById('outra-intolerancia');
            const input = document.querySelector('input[name="outra_intolerancia"]');
            if (div.style.display === 'none') {
                div.style.display = 'block';
                input.focus();
            } else {
                div.style.display = 'none';
                input.value = '';
            }
        });

        // Ensure only one address is marked as principal
        document.querySelectorAll('input[name$="is_principal"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    document.querySelectorAll('input[name$="is_principal"]').forEach(other => {
                        if (other !== this) {
                            other.checked = false;
                        }
                    });
                }
            });
        });

        // Dynamically add new address form
        document.getElementById('add-endereco').addEventListener('click', function() {
            const formsetContainer = document.getElementById('endereco-formset-container');
            const totalForms = document.querySelector('#id_form-TOTAL_FORMS');
            const formCount = parseInt(totalForms.value);
            
            const newForm = document.createElement('div');
            newForm.className = 'endereco-formset mb-3 p-3 border rounded';
            
            // Clone the first formset and update indices
            const firstForm = formsetContainer.querySelector('.endereco-formset').cloneNode(true);
            firstForm.innerHTML = firstForm.innerHTML.replace(/form-\d+/g, `form-${formCount}`);
            newForm.innerHTML = firstForm.innerHTML;
            
            // Clear input values and add listener to new CEP input
            newForm.querySelectorAll('input').forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
                if (input.name.endsWith('cep')) {
                    input.addEventListener('input', function() {
                        formatAndFetchCep(this);
                    });
                }
            });
            
            formsetContainer.appendChild(newForm);
            totalForms.value = formCount + 1;
        });
    });
</script>
{% endblock %}