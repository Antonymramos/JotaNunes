{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid" style="width: 100%; padding-right: 0;">
    <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-gradient" style="background: linear-gradient(45deg, #007bff, #00b7eb); border-radius: 5px 5px 0 0;">
            <h5 class="text-white m-0" style="font-size: 1.2rem; font-weight: 600;">{{ content_title }}</h5>
        </div>
        <div class="card-body d-flex flex-column h-100 p-3" style="background: #f8f9fa;">
            <div class="mb-3 d-flex justify-content-between flex-wrap gap-2">
                <a href="{% url 'clientes:cadastrar_cliente' %}" class="btn btn-success" style="background: linear-gradient(45deg, #28a745, #34ce57); border: none; border-radius: 5px; padding: 8px 15px; transition: all 0.3s ease; color: #fff;">
                    <i class="bi bi-person-plus-fill me-2"></i> Cadastrar Novo Cliente
                </a>
            </div>
            {% if messages %}
            <div class="alert alert-success alert-dismissible fade show mb-3" role="alert" style="color: #000; border-radius: 5px; background: #d4edda;">
                {% for message in messages %}
                {{ message }}
                {% endfor %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}
            <!-- Form de Filtro -->
            <form method="get" class="mb-3">
                <div class="mb-3">
                    <label for="searchInput" class="form-label">Buscar por Nome, Apelido ou Bairro</label>
                    <input type="text" class="form-control" id="searchInput" name="search" placeholder="Pesquisar..." style="border-radius: 5px; color: #000; border: 1px solid #ced4da;">
                </div>
                <div class="mb-3">
                    <label for="status" class="form-label">Status</label>
                    {{ filtro_form.status }}
                </div>
                <button type="submit" class="btn btn-primary" style="color: #fff; background: linear-gradient(45deg, #007bff, #00b7eb); border: none; border-radius: 5px;">
                    <i class="bi bi-filter me-2"></i> Filtrar
                </button>
            </form>
            {% if clientes %}
            <div class="table-responsive flex-grow-1" style="max-height: 60vh;">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr class="bg-light">
                            <th style="width: 20%; color: #000; font-size: 0.95rem; font-weight: 500; cursor: pointer;" onclick="sortTable(0)">Nome <i class="bi bi-arrow-down-up"></i></th>
                            <th style="width: 15%; color: #000; font-size: 0.95rem; font-weight: 500; cursor: pointer;" onclick="sortTable(1)">Apelido <i class="bi bi-arrow-down-up"></i></th>
                            <th style="width: 15%; color: #000; font-size: 0.95rem; font-weight: 500; cursor: pointer;" onclick="sortTable(2)">Data de Nascimento <i class="bi bi-arrow-down-up"></i></th>
                            <th style="width: 30%; color: #000; font-size: 0.95rem; font-weight: 500; cursor: pointer;" onclick="sortTable(3)">Endereço Completo <i class="bi bi-arrow-down-up"></i></th>
                            <th style="width: 15%; color: #000; font-size: 0.95rem; font-weight: 500; cursor: pointer;" onclick="sortTable(4)">Bairro <i class="bi bi-arrow-down-up"></i></th>
                            <th style="width: 10%; color: #000; font-size: 0.95rem; font-weight: 500; cursor: pointer;" onclick="sortTable(5)">Status <i class="bi bi-arrow-down-up"></i></th>
                            <th style="width: 15%; color: #000; font-size: 0.95rem; font-weight: 500;">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="clientTableBody">
                        {% for cliente in clientes %}
                        <tr>
                            <td data-label="Nome" style="color: #000; font-size: 1rem; font-weight: 400;">{{ cliente.nome|default:"Sem nome" }}</td>
                            <td data-label="Apelido" style="color: #000; font-size: 1rem; font-weight: 400;">{{ cliente.apelido|default:"Sem apelido" }}</td>
                            <td data-label="Data de Nascimento" style="color: #000; font-size: 1rem; font-weight: 400;">{{ cliente.data_nascimento|date:"d/m/Y"|default:"Sem data" }}</td>
                            <td data-label="Endereço Completo" style="color: #000; font-size: 1rem; font-weight: 400;">
                                {{ cliente.get_endereco_completo|default:"Sem endereço" }}
                            </td>
                            <td data-label="Bairro" style="color: #000; font-size: 1rem; font-weight: 400;">
                                {{ cliente.get_endereco_principal.bairro|default:"Sem bairro" }}
                            </td>
                            <td data-label="Status" style="color: #000; font-size: 1rem; font-weight: 400;">{{ cliente.ativo|yesno:"Ativo,Inativo" }}</td>
                            <td data-label="Ações">
                                <a href="{% url 'clientes:visualizar_cliente' cliente.id %}" class="btn btn-info btn-sm me-2" style="color: #fff; background: #17a2b8; border: none; border-radius: 5px;" title="Visualizar" aria-label="Visualizar cliente {{ cliente.nome|default:'Sem nome' }}">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{% url 'clientes:editar_cliente' cliente.id %}" class="btn btn-primary btn-sm me-2" style="color: #fff; background: #007bff; border: none; border-radius: 5px;" title="Editar" aria-label="Editar cliente {{ cliente.nome|default:'Sem nome' }}">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal{{ cliente.id }}" style="color: #fff; background: #dc3545; border: none; border-radius: 5px;" title="Excluir" aria-label="Excluir cliente {{ cliente.nome|default:'Sem nome' }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        <!-- Modal de Confirmação -->
                        <div class="modal fade" id="deleteModal{{ cliente.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ cliente.id }}" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content" style="border-radius: 5px;">
                                    <div class="modal-header" style="background: #f8f9fa;">
                                        <h5 class="modal-title" id="deleteModalLabel{{ cliente.id }}" style="color: #000; font-size: 1.2rem; font-weight: 600;">Confirmar Deleção</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body" style="color: #000; font-size: 1rem; font-weight: 400;">
                                        Tem certeza que deseja deletar o cliente "{{ cliente.nome|default:'Sem nome' }}"?
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="color: #000; border-radius: 5px;">Cancelar</button>
                                        <form method="post" action="{% url 'clientes:excluir_cliente' cliente.id %}" style="margin: 0;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger" style="color: #fff; background: #dc3545; border: none; border-radius: 5px;">Deletar</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-center text-muted" style="font-size: 1rem; font-weight: 400;">Nenhum cliente cadastrado.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
    .table thead th {
        font-size: 0.95rem;
        transition: background-color 0.3s;
    }
    .table thead th:hover {
        background-color: #e9ecef;
    }
    .btn-sm {
        padding: 4px 8px;
        font-size: 0.875rem;
    }
    .btn-info {
        background-color: #17a2b8;
        border-color: #17a2b8;
    }
    .btn-info:hover {
        background-color: #138496;
        border-color: #138496;
    }
    .btn-success:hover {
        background: linear-gradient(45deg, #218838, #2eca5a);
        transform: translateY(-2px);
    }
    .btn-primary:hover {
        background: linear-gradient(45deg, #005cbf, #0096cc);
        transform: translateY(-2px);
    }
    .card-body {
        display: flex;
        flex-direction: column;
    }
    .table-responsive {
        flex-grow: 1;
        overflow-y: auto;
        max-height: 60vh;
    }
    .input-group .form-control:focus, .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }
    @media (max-width: 768px) {
        .table {
            font-size: 0.85rem;
        }
        .table thead {
            display: none;
        }
        .table tbody tr {
            display: block;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        .table tbody td {
            display: block;
            text-align: right;
            padding: 10px;
            border: none;
            position: relative;
        }
        .table tbody td::before {
            content: attr(data-label);
            font-weight: 600;
            float: left;
            margin-right: 10px;
            color: #000;
        }
        .table tbody td:last-child {
            text-align: center;
            border-bottom: none;
        }
        .btn-sm {
            width: 100%;
            margin-top: 5px;
            margin-right: 0;
        }
        .d-flex {
            flex-direction: column;
            gap: 10px;
        }
    }
</style>
<script>
    let sortDirection = 1;
    function sortTable(columnIndex) {
        const tbody = document.getElementById('clientTableBody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
            let aValue = a.cells[columnIndex].textContent.trim();
            let bValue = b.cells[columnIndex].textContent.trim();
            if (columnIndex === 2) {
                aValue = aValue === 'Sem data' ? '' : aValue.split('/').reverse().join('');
                bValue = bValue === 'Sem data' ? '' : bValue.split('/').reverse().join('');
            }
            return aValue.localeCompare(bValue, undefined, { numeric: true }) * sortDirection;
        });
        sortDirection *= -1;
        rows.forEach(row => tbody.appendChild(row));
    }

    document.getElementById('searchInput').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#clientTableBody tr');
        rows.forEach(row => {
            const nome = row.cells[0].textContent.toLowerCase();
            const apelido = row.cells[1].textContent.toLowerCase();
            const bairro = row.cells[4].textContent.toLowerCase();
            const matches = nome.includes(searchTerm) || apelido.includes(searchTerm) || bairro.includes(searchTerm);
            row.style.display = matches ? '' : 'none';
        });
    });
</script>
{% endblock %}