{% extends 'core/base.html' %}
{% block content_title %}Lista de Compras{% endblock %}
{% block content %}
<div class="container-fluid" style="width: 100%; padding-right: 0;">
  <div class="card border-0 shadow-sm" style="border-radius: 15px;">
    <div class="card-header bg-gradient d-flex justify-content-between align-items-center" style="background: linear-gradient(45deg, #dc3545, #e4606d); border-top-left-radius: 15px; border-top-right-radius: 15px;">
      <h5 class="text-white m-0" style="font-size: 1.3rem; font-weight: 600;">Lista de Compras</h5>
      <div class="d-flex gap-2">
        <a href="{% url 'ingredientes:lista_ingredientes' %}" class="btn btn-light btn-sm" style="color: #000; border-radius: 8px; padding: 6px 12px; transition: all 0.3s ease;">
          <i class="bi bi-arrow-left"></i> Voltar
        </a>
        <form method="post" style="display:inline;">
          {% csrf_token %}
          <button type="submit" name="download_pdf" class="btn btn-success btn-sm rounded-pill" style="color: #000; transition: all 0.3s ease;">
            <i class="bi bi-download"></i> Download PDF
          </button>
        </form>
      </div>
    </div>
    <div class="card-body p-4" style="background: #fff; border-bottom-left-radius: 15px; border-bottom-right-radius: 15px;">
      <form method="get" class="row g-3 mb-3">
        <div class="col-12 col-md-3">
          <input type="text" name="nome_busca" class="form-control rounded-pill" placeholder="Buscar por nome" value="{{ nome_busca|default:'' }}" onchange="this.form.submit()" style="color: #000;">
        </div>
        <div class="col-12 col-md-3">
          <select name="unidade_medida" class="form-select rounded-pill" onchange="this.form.submit()" style="color: #000;">
            <option value="">Todas as Unidades</option>
            <option value="kg" {% if unidade_medida == 'kg' %}selected{% endif %}>Kilograma (kg)</option>
            <option value="litro" {% if unidade_medida == 'litro' %}selected{% endif %}>Litro (L)</option>
            <option value="unidade" {% if unidade_medida == 'unidade' %}selected{% endif %}>Unidade</option>
            <option value="grama" {% if unidade_medida == 'grama' %}selected{% endif %}>Grama (g)</option>
            <option value="mililitro" {% if unidade_medida == 'mililitro' %}selected{% endif %}>Mililitro (mL)</option>
            <option value="saco" {% if unidade_medida == 'saco' %}selected{% endif %}>Saco</option>
          </select>
        </div>
        <div class="col-12 col-md-3">
          <input type="number" name="custo_min" class="form-control rounded-pill" placeholder="Custo Mínimo (R$)" value="{{ custo_min|default:'' }}" step="0.01" onchange="this.form.submit()" style="color: #000;">
        </div>
        <div class="col-12 col-md-2">
          <input type="number" name="custo_max" class="form-control rounded-pill" placeholder="Custo Máximo (R$)" value="{{ custo_max|default:'' }}" step="0.01" onchange="this.form.submit()" style="color: #000;">
        </div>
        <div class="col-12 col-md-1">
          <button type="button" class="btn btn-secondary btn-sm rounded-pill w-100" onclick="this.form.querySelectorAll('input, select').forEach(el => el.value = ''); this.form.submit();" style="color: #000;">
            Limpar
          </button>
        </div>
      </form>
      {% if ingredientes_com_calculo %}
      <table class="table table-striped table-hover" style="color: #000;">
        <thead>
          <tr class="bg-light">
            <th style="font-size: 1rem; font-weight: 500;">Ingrediente</th>
            <th style="font-size: 1rem; font-weight: 500;">Estoque Atual</th>
            <th style="font-size: 1rem; font-weight: 500;">Quantidade Mínima</th>
            <th style="font-size: 1rem; font-weight: 500;">Quantidade a Comprar</th>
            <th style="font-size: 1rem; font-weight: 500;">Custo Estimado</th>
          </tr>
        </thead>
        <tbody>
          {% for item in ingredientes_com_calculo %}
          <tr>
            <td style="font-size: 1rem; font-weight: 400;">{{ item.ingrediente.nome }}</td>
            <td style="font-size: 1rem; font-weight: 400;">{{ item.ingrediente.quantidade_estoque }} {{ item.ingrediente.unidade_medida }}</td>
            <td style="font-size: 1rem; font-weight: 400;">{{ item.ingrediente.quantidade_minima }} {{ item.ingrediente.unidade_medida }}</td>
            <td style="font-size: 1rem; font-weight: 400;">{{ item.quantidade_a_comprar }} {{ item.ingrediente.unidade_medida }}</td>
            <td style="font-size: 1rem; font-weight: 400;">R$ {{ item.custo_estimado|floatformat:2 }}</td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr class="bg-light">
            <td colspan="4" class="text-end" style="font-size: 1rem; font-weight: 600;"><strong>Total Estimado:</strong></td>
            <td style="font-size: 1rem; font-weight: 600;"><strong>R$ {{ total_custo|floatformat:2 }}</strong></td>
          </tr>
        </tfoot>
      </table>
      <p class="text-muted mt-3" style="color: #000; font-size: 1rem; font-weight: 400;">* Quantidade a comprar sugerida: dobro da quantidade mínima. Custo baseado no preço unitário.</p>
      {% else %}
      <p class="text-center text-muted" style="color: #000; font-size: 1rem; font-weight: 400;">Nenhum ingrediente precisa de reposição no momento.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
{% block extra_scripts %}
<style>
  .form-control:focus {
    border-color: #dc3545;
    box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
  }
  .btn-light:hover { background: #e9ecef; transform: translateY(-2px); }
  .btn-success:hover { background: linear-gradient(45deg, #218838, #2eca5a); transform: translateY(-2px); }
  .btn-secondary:hover { background: #5a6268; transform: translateY(-2px); }
  @media (max-width: 768px) {
    .row.g-3 { flex-direction: column; }
    .col-12 { margin-bottom: 10px; }
    .btn { width: 100%; margin-bottom: 10px; }
    .table thead th { font-size: 0.85rem; }
  }
  @media (max-width: 576px) {
    .table { font-size: 0.8rem; }
  }
</style>
<script>
  document.querySelectorAll('input, select').forEach(el => {
    el.addEventListener('change', function() {
      this.form.submit();
    });
  });
</script>
{% endblock %}